var application_root=__dirname,express=require("express"),morgan=require("morgan"),bodyParser=require("body-parser"),errorHandler=require("errorhandler"),path=require("path"),request=require("request"),fs=require("fs"),app=express(),env=process.env.NODE_ENV||"development";"development"==env&&(app.use("/",express.static(path.join(application_root,"app"))),app.use(morgan("dev")),app.use(bodyParser()),app.use(errorHandler({dumpExceptions:!0,showStack:!0})));var ipaddr=process.env.OPENSHIFT_NODEJS_IP||"127.0.0.1",port=parseInt(process.env.OPENSHIFT_NODEJS_PORT)||8e3;app.set("ipaddr",ipaddr),app.set("port",port);var server=app.listen(port,ipaddr,function(){console.log("Express server listening on port %d in %s mode",port,app.settings.env)}),io=require("socket.io").listen(server),parse=JSON.parse("{}");try{parse=JSON.parse(fs.readFileSync("trafikFile.json"))}catch(e){console.log("Error")}var update=function(){var e="http://api.sr.se/api/v2/traffic/messages?format=json&size=5000&indent=true";request(e,function(e,r,s){if(e!==!0&&200==r.statusCode){var a=JSON.parse(s);if(JSON.stringify(a)!==JSON.stringify(parse))try{parse=a,io.sockets.emit("load",a),fs.writeFile("trafikFile.json",s,function(e){if(e)throw e})}catch(t){fs.writeFile("trafikFile.json","{}")}else console.log("Ingen ny data")}})};update(),setInterval(update,3e5),io.sockets.on("connection",function(e){e.emit("load",parse)}),app.get("/map",function(){});